# Sample workflow for building and deploying a Jekyll site to GitHub Pages
name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  # Runs on pushes targeting the default branch
  push: 
    # branches: ["devel"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Clone repo controller_configuration
        run: mkdir _temp; git clone https://github.com/redhat-cop/controller_configuration.git _temp/controller_configuration
      - name: Clone repo galaxy_collection
        run: git clone https://github.com/ansible/galaxy_collection.git _temp/galaxy_collection
      - name: Clone repo eda_configuration
        run: git clone https://github.com/redhat-cop/eda_configuration.git _temp/eda_configuration
      - name: Clone repo aap_utilities
        run: git clone https://github.com/redhat-cop/aap_utilities.git _temp/aap_utilities
      - name: Clone repo ee_utilities
        run: git clone https://github.com/redhat-cop/ee_utilities.git _temp/ee_utilities
      - name: Get all readme's
        run: export mypath=$(pwd); cd _temp/; for i in $(ls); do cd "$i"/roles ; for y in $(ls); do cd "$y"; mv README.md "$mypath"/_collections/"$i"/"$y".md; cd "$mypath"/_temp/"$i"/roles; done; cd "$mypath"/_temp; done
      - name: Install Ansible
        run: pip install ansible-core
      - name: Run Ansible
        run: cd .github; ansible-playbook playbook.yml
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - uses: stefanzweifel/git-auto-commit-action@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
